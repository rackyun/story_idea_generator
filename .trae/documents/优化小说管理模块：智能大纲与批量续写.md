# 优化小说管理模块实施计划

本计划旨在通过增强大纲管理和多章续写功能，提升小说创作的连贯性与可控性。

## 1. 数据库层升级 (`database.py`)
### 新增 `novel_outlines` 表
创建用于存储大纲版本的专用表，支持版本控制。
- **字段设计**：
  - `id`: 主键
  - `novel_id`: 关联小说 ID (外键)
  - `version`: 版本号 (自动递增)
  - `content`: 大纲内容 (JSON 格式，存储分章详情)
  - `created_at`: 创建时间
  - `is_active`: 是否为当前启用版本

### 新增 `OutlineManager` 类
- `save_outline(novel_id, content)`: 保存新版本大纲。
- `get_latest_outline(novel_id)`: 获取当前激活的大纲。
- `get_outline_history(novel_id)`: 获取大纲历史版本列表。
- `update_outline_node(novel_id, chapter_index, new_content)`: 更新特定章节的大纲内容。

## 2. 核心逻辑增强 (`crew_tasks.py`)
### 新增智能任务
1.  **`outline_expansion_task` (大纲智能扩充)**
    - **输入**：现有大纲、已完成章节摘要、续写章数 (n)。
    - **功能**：分析故事走向，自动生成后续 n 章的详细大纲。
2.  **`batch_chapter_writing_task` (批量续写)**
    - **输入**：指定的大纲段落（如第 5-8 章）。
    - **功能**：保持上下文连贯性，批量生成多个章节内容。
3.  **`quality_assessment_task` (质量评估)**
    - **输入**：生成的新章节。
    - **功能**：评估逻辑连贯性、风格一致性和大纲符合度。

## 3. UI 界面升级 (`pages/3_📚_小说管理.py`)
### 新增 "📑 大纲管理" 标签页
- **大纲编辑器**：按章节卡片式展示大纲，支持点击编辑、拖拽排序（预留）、删除。
- **智能生成区**：设置“每 n 章生成一段”，一键调用 `outline_expansion_task`。
- **版本控制区**：下拉选择历史版本，支持“回滚”或“查看对比”。

### 优化 "📝 章节管理" 标签页
- **智能续写面板**：
  - **模式选择**：单章精修 / 批量续写。
  - **大纲驱动**：勾选“基于当前大纲续写”，自动读取 `novel_outlines` 中的设定。
  - **质量报告**：续写完成后显示 AI 给出的质量评分和改进建议。

## 4. 实施步骤
1.  **数据库迁移**：修改 `database.py` 并运行迁移脚本创建新表。
2.  **后端逻辑**：实现 `OutlineManager` 及新的 CrewAI Task。
3.  **前端开发**：构建大纲管理 UI 和续写交互界面。
4.  **联调测试**：验证大纲生成 -> 修改 -> 续写 -> 评估的全流程。
